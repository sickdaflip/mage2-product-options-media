<?php
/*
 * Copyright (C) Philipp Breitsprecher, Inc - All Rights Reserved
 * @project Mage2 GD
 * @file select.phtml
 * @author Philipp Breitsprecher
 * @date 18.11.25, 12:39
 * @email philippbreitsprecher@gmail.com
 */

declare(strict_types=1);

use Magento\Catalog\Block\Product\View\Options\Type\Select;
use Magento\Framework\Escaper;
use Sickdaflip\ProductOptionsMedia\Model\Product\Option\Value\Media;

/** @var Select $block */
/** @var Escaper $escaper */

$_option = $block->getOption();
$_store = $block->getProduct()->getStore();
$mediaUrl = $_store->getBaseUrl(\Magento\Framework\UrlInterface::URL_TYPE_MEDIA);

// Get Media helper for image URL resolution
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$mediaHelper = $objectManager->get(Media::class);
?>

<?php if ($_option->getType() == \Magento\Catalog\Model\Product\Option::OPTION_TYPE_RADIO
    || $_option->getType() == \Magento\Catalog\Model\Product\Option::OPTION_TYPE_CHECKBOX): ?>

    <div class="option-select card" x-data="{ openModal: null }">
        <label class="label font-medium text-gray-900 mb-2 block">
            <?= $escaper->escapeHtml($_option->getTitle()) ?>
            <?php if ($_option->getIsRequire()): ?>
                <span class="text-red-600">*</span>
            <?php endif; ?>
        </label>

        <ul class="options-list grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <?php $count = 0; ?>
            <?php foreach ($_option->getValues() as $_value): ?>
                <?php
                $count++;
                $priceStr = $block->formatPrice([
                    'is_percent' => ($_value->getPriceType() == 'percent'),
                    'pricing_value' => $_value->getPrice($_value->getPriceType() == 'percent')
                ]);
                $htmlValue = $_value->getOptionTypeId();
                $hasImage = $_value->getData('image');
                $hasDescription = $_value->getData('description');
                $inputType = $_option->getType() == \Magento\Catalog\Model\Product\Option::OPTION_TYPE_RADIO ? 'radio' : 'checkbox';
                $inputName = 'options[' . $_option->getId() . ']' . ($inputType == 'checkbox' ? '[]' : '');

                // DEBUG - remove after testing
                echo '<pre>Value Data: ' . print_r($_value->getData(), true) . '</pre>';
                ?>

                <li class="option-value-item border rounded-lg p-4 hover:border-primary transition-colors
                    <?= $hasImage ? 'with-image' : '' ?>
                    <?= $hasDescription ? 'with-description' : '' ?>">

                    <div class="flex items-start gap-3">
                        <input
                            type="<?= $escaper->escapeHtmlAttr($inputType) ?>"
                            class="form-<?= $escaper->escapeHtmlAttr($inputType) ?> mt-1"
                            id="options_<?= (int)$_option->getId() ?>_<?= (int)$count ?>"
                            name="<?= $escaper->escapeHtmlAttr($inputName) ?>"
                            value="<?= (int)$htmlValue ?>"
                            data-price-amount="<?= (float)$_value->getPrice(true) ?>"
                            data-price-type="<?= $escaper->escapeHtmlAttr($_value->getPriceType()) ?>"
                            data-option-id="<?= (int)$_option->getId() ?>_<?= (int)$_value->getOptionTypeId() ?>"
                            x-on:change="updateCustomOptionValue(
                                $dispatch, '<?= (int)$_option->getId() ?>_<?= (int)$_value->getOptionTypeId() ?>', $event.target
                            )"
                        >

                        <label
                            for="options_<?= (int)$_option->getId() ?>_<?= (int)$count ?>"
                            class="flex-1 cursor-pointer"
                        >
                            <?php if ($hasImage): ?>
                                <?php $imageUrl = $mediaHelper->getImageUrl($_value->getData('image')); ?>
                                <?php if ($imageUrl): ?>
                                    <div class="option-image mb-2">
                                        <img
                                            src="<?= $escaper->escapeUrl($imageUrl) ?>"
                                            alt="<?= $escaper->escapeHtmlAttr($_value->getTitle()) ?>"
                                            class="w-20 h-20 object-cover rounded border"
                                            loading="lazy"
                                        >
                                    </div>
                                <?php endif; ?>
                            <?php endif; ?>

                            <div class="option-title font-medium text-gray-900">
                                <?= $escaper->escapeHtml($_value->getTitle()) ?>
                                <?php if ($priceStr): ?>
                                    <span class="text-sm text-gray-600"><?= $escaper->escapeHtml($priceStr) ?></span>
                                <?php endif; ?>
                            </div>

                            <?php if ($hasDescription): ?>
                                <button
                                    type="button"
                                    @click.prevent="openModal = '<?= (int)$_option->getId() ?>_<?= (int)$count ?>'"
                                    class="text-primary hover:text-primary-darker text-sm mt-1 flex items-center gap-1"
                                >
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    <?= $escaper->escapeHtml(__('More Info')) ?>
                                </button>
                            <?php endif; ?>
                        </label>
                    </div>
                </li>

                <?php if ($hasDescription): ?>
                    <!-- Description Modal -->
                    <template x-teleport="body">
                        <div
                            x-show="openModal === '<?= (int)$_option->getId() ?>_<?= (int)$count ?>'"
                            x-cloak
                            @keydown.escape.window="openModal = null"
                            class="fixed inset-0 z-50 overflow-y-auto"
                            style="display: none;"
                        >
                            <div
                                @click="openModal = null"
                                class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"
                            ></div>

                            <div class="flex items-center justify-center min-h-screen p-4">
                                <div
                                    x-show="openModal === '<?= (int)$_option->getId() ?>_<?= (int)$count ?>'"
                                    x-transition:enter="transition ease-out duration-300"
                                    x-transition:enter-start="opacity-0 scale-95"
                                    x-transition:enter-end="opacity-100 scale-100"
                                    x-transition:leave="transition ease-in duration-200"
                                    x-transition:leave-start="opacity-100 scale-100"
                                    x-transition:leave-end="opacity-0 scale-95"
                                    class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full p-6 relative"
                                    @click.stop
                                >
                                    <h3 class="text-lg font-bold text-gray-900 mb-4">
                                        <?= $escaper->escapeHtml($_value->getTitle()) ?>
                                    </h3>

                                    <div class="prose prose-sm max-w-none text-gray-700">
                                        <?= /* @noEscape */ $_value->getData('description') ?>
                                    </div>

                                    <div class="mt-6 flex justify-end">
                                        <button
                                            type="button"
                                            @click="openModal = null"
                                            class="btn btn-primary"
                                        >
                                            <?= $escaper->escapeHtml(__('Close')) ?>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                <?php endif; ?>
            <?php endforeach; ?>
        </ul>
    </div>

<?php else: ?>
    <?php // Render standard dropdown/multiselect - no changes needed ?>
    <?= $block->getValuesHtml() ?>
<?php endif; ?>