<?php
/*
* Copyright (C) Philipp Breitsprecher, Inc - All Rights Reserved
* @project Mage2 GD
* @file options.phtml
* @author Philipp Breitsprecher
* @date 06.10.25, 16:03
* @email philippbreitsprecher@gmail.com
*/

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\ProductPage;
use Hyva\Theme\ViewModel\ProductPrice;
use Magento\Catalog\Block\Product\View\Options;
use Magento\Catalog\Model\Product\Option;
use Magento\Framework\Escaper;

/** @var Escaper $escaper */
/** @var Options $block */
/** @var ViewModelRegistry $viewModels */
/** @var Option $option */

/** @var ProductPage $productViewModel */
$productViewModel = $viewModels->require(ProductPage::class);

$product = $block->getProduct();
/** @var ProductPrice $productPriceViewModel */
$productPriceViewModel = $viewModels->require(ProductPrice::class);
$displayTax = $productPriceViewModel->displayPriceIncludingTax();
$options = $block->decorateArray($block->getOptions());

?>
<?php if (count($options)): ?>
    <?php
    // Collect all descriptions from all options for global modal
    $allDescriptions = [];
    foreach ($options as $option) {
        if ($option->getType() === \Magento\Catalog\Model\Product\Option::OPTION_TYPE_RADIO ||
            $option->getType() === \Magento\Catalog\Model\Product\Option::OPTION_TYPE_CHECKBOX) {
            foreach ($option->getValues() as $value) {
                if ($value->getData('description')) {
                    $optionId = $option->getId() . '_' . $value->getOptionTypeId();
                    $allDescriptions[$optionId] = [
                        'title' => $value->getTitle(),
                        'description' => $value->getData('description')
                    ];
                }
            }
        }
    }
    ?>
    <script>
        function initOptions() {
            return {
                optionConfig: <?= /* @noEscape */ $block->getJsonConfig() ?>,
                regularPriceKey: '<?= /* @noEscape */ $displayTax ? 'oldPrice' : 'baseOldPrice' ?>',
                finalPriceKey: '<?= /* @noEscape */ $displayTax ? 'finalPrice' : 'basePrice' ?>',
                productFinalPrice: false,
                customOptionPrices: {},
                <?php if ($productPriceViewModel->displayPriceInclAndExclTax()): ?>
                productBasePrice: false,
                customOptionBasePrices: {},
                <?php endif; ?>
                refs: [],
                getFormattedOptionPrice(optionId) {
                    if (this.customOptionPrices[optionId]) {
                        const showSign = true;
                        return hyva.formatPrice(this.customOptionPrices[optionId], showSign);
                    }
                    return false;
                },

                <?php if ($productPriceViewModel->displayPriceInclAndExclTax()): ?>
                getFormattedOptionBasePrice(optionId) {
                    if (this.customOptionBasePrices[optionId]) {
                        const showSign = true;
                        return hyva.formatPrice(this.customOptionBasePrices[optionId], showSign);
                    }
                    return false;
                },
                <?php endif; ?>

                updateOptionPrice(optionId, optionPriceEl) {
                    const container = document.createElement('div');
                    container.innerHTML = optionPriceEl.innerHTML;

                    const price = this.customOptionPrices[optionId];

                    if (price !== undefined) {
                        const priceNotice = container.querySelector('.price-notice');

                        if (priceNotice) {
                            // Get the current sign (first text node)
                            const firstTextNode = Array.from(priceNotice.childNodes)
                                .find(node => node.nodeType === Node.TEXT_NODE);

                            if (firstTextNode) {
                                // Replace the sign based on price value
                                firstTextNode.textContent = price < 0 ? '-' : '+';
                            }
                        }

                        // Update the actual price value
                        const priceEl = container.querySelector('.price-wrapper');
                        if (priceEl) {
                            priceEl.textContent = hyva.formatPrice(Math.abs(price));
                        }
                    }

                    <?php if ($productPriceViewModel->displayPriceInclAndExclTax()): ?>
                    const basePrice = this.customOptionBasePrices[optionId];

                    if (basePrice !== undefined) {
                        const basePriceEl = container.querySelector('.price-excluding-tax .price');
                        if (basePriceEl) {
                            basePriceEl.textContent = hyva.formatPrice(Math.abs(basePrice));
                        }
                    }
                    <?php endif; ?>

                    return container.innerHTML;
                },

                calculateOptionPrices() {
                    for (const [customOptionId, customOption] of Object.entries(this.optionConfig)) {
                        if (customOption.prices) {
                            this.customOptionPrices[customOptionId] = this.calculateOptionPrice(customOption, customOptionId);
                            <?php if ($productPriceViewModel->displayPriceInclAndExclTax()): ?>
                            this.customOptionBasePrices[customOptionId] = this.calculateOptionBasePrice(customOption, customOptionId);
                            <?php endif; ?>
                        } else {
                            for (const [childCustomOptionId, childCustomOption] of Object.entries(customOption)) {
                                const key = customOptionId + '_' + childCustomOptionId;
                                this.customOptionPrices[key] = this.calculateOptionPrice(childCustomOption, customOptionId, childCustomOptionId);
                                <?php if ($productPriceViewModel->displayPriceInclAndExclTax()): ?>
                                this.customOptionBasePrices[key] = this.calculateOptionBasePrice(childCustomOption, customOptionId, childCustomOptionId);
                                <?php endif; ?>
                            }
                        }
                    }

                    window.dispatchEvent(new CustomEvent("update-custom-option-prices", {detail: this.customOptionPrices}));

                    <?php if ($productPriceViewModel->displayPriceInclAndExclTax()): ?>
                    window.dispatchEvent(new CustomEvent("update-custom-option-base-prices", {detail: this.customOptionBasePrices}));
                    <?php endif; ?>
                },

                calculateOptionPrice(customOption, customOptionId, childCustomOptionId) {
                    const customOptionCode = customOptionId + (childCustomOptionId ? '-' + childCustomOptionId : '');

                    const optionElement = this.refs && this.refs['option-' + customOptionCode];

                    let price = customOption.prices[this.finalPriceKey].amount;

                    if (this.productFinalPrice &&
                        optionElement &&
                        optionElement.dataset.priceAmount &&
                        optionElement.dataset.priceType
                    ) {
                        price = optionElement.dataset.priceType !== 'percent' ?
                            optionElement.dataset.priceAmount :
                            this.productFinalPrice * (optionElement.dataset.priceAmount / 100)
                    }

                    return price;
                },

                <?php if ($productPriceViewModel->displayPriceInclAndExclTax()): ?>
                calculateOptionBasePrice(customOption, customOptionId, childCustomOptionId) {
                    const customOptionCode = customOptionId + (childCustomOptionId ? '-' + childCustomOptionId : '');

                    const optionElement = this.refs && this.refs['option-' + customOptionCode];

                    let basePrice = customOption.prices['basePrice'].amount;

                    if (this.productBasePrice &&
                        optionElement &&
                        optionElement.dataset.basePriceAmount &&
                        optionElement.dataset.priceType
                    ) {
                        basePrice = optionElement.dataset.priceType !== 'percent' ?
                            optionElement.dataset.basePriceAmount :
                            this.productBasePrice * (optionElement.dataset.priceAmount / 100)
                    }

                    return basePrice;
                },
                <?php endif; ?>

                updateCustomOptionValue($dispatch, customOptionId, target) {
                    let active;
                    switch (target.type) {
                        case 'text':
                        case 'textarea':
                        case 'file':
                        case 'time':
                        case 'datetime-local':
                        case 'date':
                            active = !!target.value;
                            break;
                        case 'hidden':
                            // when we're configuring an item in the cart that already has an attachment
                            // this is only needed on page-initialization
                            active = (target.value === 'save_old')
                            break;
                        case 'select-one':
                        case 'select-multiple':
                            Array.from(target.options).forEach(option => {
                                customOptionId = option.dataset.optionId;
                                active = option.selected;
                                $dispatch('update-custom-option-active', {customOptionId, active});
                            });
                            return;
                            break;
                        case 'radio':
                            target.checked && document.querySelectorAll('input[name="' + target.name + '"]')
                                .forEach(input => {
                                    // unset sibling radio buttons
                                    input.dataset &&
                                    input.dataset.optionId &&
                                    input !== target && $dispatch('update-custom-option-active',
                                        {
                                            customOptionId: input.dataset.optionId,
                                            active: false
                                        }
                                    );
                                });
                        // DO NOT BREAK
                        // Checkbox case should also run for Radio
                        case 'checkbox':
                            const requiredOptions = document
                                .querySelectorAll('input[name="' + target.name + '"][data-required]');
                            const checkedOptionsQty = Array.from(requiredOptions)
                                .filter(option => option.checked).length;

                            requiredOptions.forEach(input => {
                                if (checkedOptionsQty) {
                                    input.required = false;
                                    input.setCustomValidity('');
                                } else {
                                    input.required = false;
                                    input.setCustomValidity(input.dataset.validationMessage);
                                }
                            });
                            active = target.checked;
                            break;
                    }
                    $dispatch('update-custom-option-active', {customOptionId, active});
                },

                initSelectedOptions($dispatch) {
                    Array.from(document.querySelectorAll('.product-custom-option')).forEach(customOption => {
                        this.updateCustomOptionValue($dispatch, customOption.dataset.optionId, customOption);
                    })
                },

                eventListeners: {
                    ['@update-product-final-price.window'](event) {
                        this.productFinalPrice = event.detail;
                        this.calculateOptionPrices();
                    },
                    <?php if ($productPriceViewModel->displayPriceInclAndExclTax()): ?>
                    ['@update-product-base-price.window'](event) {
                        this.productBasePrice = event.detail;
                        this.calculateOptionPrices();
                    }<?php endif; ?>
                }
            }
        }

    </script>
    <div x-data="initOptions()"
         x-init="
    refs = $refs;
    $nextTick(() => {
        calculateOptionPrices();
        initSelectedOptions($dispatch);
        // Initialize show more/less after Alpine renders
        setTimeout(() => { if (typeof initShowMoreLess === 'function') initShowMoreLess(); }, 100);
    })
 "
         x-bind="eventListeners"
         class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-sm">
        <?php foreach ($options as $option): ?>
            <?= $block->getOptionHtml($option) ?>
        <?php endforeach; ?>
    </div>

    <?php if (!empty($allDescriptions)): ?>
    <!-- Global modal for all option descriptions -->
    <div x-data="initOptionDescriptionModal"
         data-descriptions="<?= $escaper->escapeHtmlAttr(json_encode($allDescriptions)) ?>"
         @open-option-modal.window="openModal = $event.detail.optionId">
        <template x-if="openModal !== null">
            <div @keydown.escape.window="openModal = null"
                 class="fixed inset-0 z-50 overflow-y-auto"
                 x-cloak>
                <div @click="openModal = null"
                     class="fixed inset-0 bg-black opacity-50 transition-opacity"></div>

                <div class="flex items-center justify-center min-h-screen p-4">
                    <div
                            x-data="{
                        get modalData() {
                            return descriptions[openModal] || { title: '', description: '' };
                        }
                    }"
                            x-transition:enter-start="opacity-0 scale-95"
                            x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave-start="opacity-100 scale-100"
                            x-transition:leave-end="opacity-0 scale-95"
                            @click.stop
                            class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full p-6 relative text-gray-700">
                        <template x-if="modalData.title">
                            <p class="text-lg font-bold text-gray-900 mb-4" x-text="modalData.title"></p>
                        </template>

                        <template x-if="modalData.description">
                            <div class="prose prose-sm max-w-none text-gray-700" x-html="modalData.description"></div>
                        </template>

                        <div class="mt-6 flex justify-end">
                            <button
                                    type="button"
                                    @click="openModal = null"
                                    class="btn btn-primary"
                            >
                                <?= $escaper->escapeHtml(__('Close')) ?>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>
    <?php endif; ?>
<?php endif; ?>
