<?php
/*
 * Copyright (C) Philipp Breitsprecher, Inc - All Rights Reserved
 * @project Mage2 GD
 * @file checkable.phtml
 * @author Philipp Breitsprecher
 * @date 18.11.25
 * @email philippbreitsprecher@gmail.com
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\ProductPrice;
use Magento\Catalog\Block\Product\View\Options\Type\Select\Checkable;
use Magento\Catalog\Model\Product\Option;
use Magento\Catalog\Pricing\Price\CustomOptionPrice;
use Magento\Framework\Escaper;
use Magento\Framework\View\Helper\SecureHtmlRenderer;
use Sickdaflip\ProductOptionsMedia\ViewModel\MediaHelper;

/**
 * @var Checkable $block
 * @var Escaper $escaper
 * @var ViewModelRegistry $viewModels
 * @var SecureHtmlRenderer $secureRenderer
 */

$product = $block->getProduct();

/** @var ProductPrice $productPriceViewModel */
$productPriceViewModel = $viewModels->require(ProductPrice::class);

/** @var Hyva\Theme\ViewModel\HeroiconsOutline $heroicons */
$heroicons = $viewModels->require(\Hyva\Theme\ViewModel\HeroiconsOutline::class);

/** @var MediaHelper $mediaHelper */
$mediaHelper = $viewModels->require(MediaHelper::class);

$option = $block->getOption();

if ($option): ?>
    <?php
    $configValue = $block->getPreconfiguredValue($option);
    $optionType = $option->getType();
    $arraySign = $optionType === Option::OPTION_TYPE_CHECKBOX ? '[]' : '';

    // Sammle alle Descriptions fÃ¼r das gemeinsame Modal
    $descriptions = [];
    foreach ($option->getValues() as $value) {
        if ($value->getData('description')) {
            $optionId = $option->getId() . '_' . $value->getOptionTypeId();
            $descriptions[$optionId] = [
                    'title' => $value->getTitle(),
                    'description' => $value->getData('description')
            ];
        }
    }
    ?>

    <div x-data="initOptionModal()"
         x-init="descriptions = JSON.parse('<?= $escaper->escapeJs(json_encode($descriptions)) ?>')">

        <div class="options-list nested"
             id="options-<?= $escaper->escapeHtmlAttr($option->getId()) ?>-list"
             data-max-items="3">
            <?php if ($optionType === Option::OPTION_TYPE_RADIO && !$option->getIsRequire()): ?>
                <div class="field choice">
                    <input type="radio"
                           id="options_<?= $escaper->escapeHtmlAttr($option->getId()) ?>"
                           class="radio product-custom-option"
                           name="options[<?= $escaper->escapeHtmlAttr($option->getId()) ?>]"
                           value=""
                           checked
                           data-price-amount="0"
                           data-price-type="fixed"
                           x-on:change="typeof updateCustomOptionValue === 'function' && updateCustomOptionValue($dispatch, '<?= $escaper->escapeHtmlAttr($option->getId()) ?>', $event.target)"
                    />
                    <label class="label text-center"
                           for="options_<?= $escaper->escapeHtmlAttr($option->getId()) ?>">
                <span>
                    <?= $escaper->escapeHtml(__('None')) ?>
                </span>
                    </label>
                </div>
            <?php endif; ?>
            <?php foreach ($option->getValues() as $value): ?>
                <?php
                $checked = '';
                if ($arraySign) {
                    $checked = is_array($configValue) && in_array($value->getOptionTypeId(), $configValue) ? 'checked' : '';
                } else {
                    $checked = $configValue == $value->getOptionTypeId() ? 'checked' : '';
                }

                $optionId = $option->getId() . '_' . $value->getOptionTypeId();

                $valuePrice = $productPriceViewModel->getCustomOptionPrice($value, CustomOptionPrice::PRICE_CODE, $product);
                if ($productPriceViewModel->displayPriceInclAndExclTax()) {
                    $valueBasePrice = $value->getPrice(true);
                }

                // Get image and description
                $hasImage = $value->getData('image');
                $hasDescription = $value->getData('description');
                $imageUrl = $hasImage ? $mediaHelper->getImageUrl($value->getData('image')) : null;
                ?>
                <div class="field choice <?= $hasImage ? 'with-image' : '' ?> <?= $hasDescription ? 'with-description' : '' ?>">
                    <input type="<?= $escaper->escapeHtmlAttr($optionType) ?>"
                           class="<?= $optionType === Option::OPTION_TYPE_RADIO ? 'form-radio' : 'form-checkbox' ?> product-custom-option"
                           name="options[<?= $escaper->escapeHtmlAttr($option->getId()) ?>]<?= /* @noEscape */ $arraySign ?>"
                           id="options_<?= $escaper->escapeHtmlAttr($optionId) ?>"
                           value="<?= $escaper->escapeHtmlAttr($value->getOptionTypeId()) ?>"
                            <?= $escaper->escapeHtml($checked) ?>
                            <?php if ($option->getIsRequire()): ?>
                                <?php if ($optionType === Option::OPTION_TYPE_RADIO): ?>
                                    required
                                <?php endif; ?>
                                data-required
                                oninvalid="this.setCustomValidity(this.dataset.validationMessage)"
                                oninput="this.setCustomValidity('')"
                                data-validation-message="<?= $escaper->escapeHtmlAttr(__("Please select one of the options.")) ?>"
                            <?php endif; ?>
                           data-price-amount="<?= $escaper->escapeHtmlAttr($valuePrice) ?>"
                            <?php if ($productPriceViewModel->displayPriceInclAndExclTax()): ?>
                                data-base-price-amount="<?= $escaper->escapeHtmlAttr($valueBasePrice) ?>"
                            <?php endif; ?>
                           data-price-type="<?= $escaper->escapeHtmlAttr($value->getPriceType()) ?>"
                           x-on:change="typeof updateCustomOptionValue === 'function' && updateCustomOptionValue($dispatch, '<?= $escaper->escapeHtmlAttr($optionId) ?>', $event.target)"
                    />
                    <label class="label flex flex-row text-center items-center justify-center gap-x-2"
                           for="options_<?= $escaper->escapeHtmlAttr($optionId) ?>">
                        <?php if ($imageUrl): ?>
                            <img
                                    src="<?= $escaper->escapeUrl($imageUrl) ?>"
                                    alt="<?= $escaper->escapeHtmlAttr($value->getTitle()) ?>"
                                    class="object-contain"
                                    loading="lazy"
                                    width="75"
                                    height="75"
                            >
                        <?php endif; ?>
                        <span class="text"><?= $escaper->escapeHtml($value->getTitle()) ?> <?= /* @noEscape */ $block->formatPrice($value) ?></span>
                    </label>
                    <?php if ($hasDescription): ?>
                        <button
                                type="button"
                                @click.prevent="openModal = '<?= $escaper->escapeHtmlAttr($optionId) ?>'"
                        >
                            <span class="bg-primary text-sm w-6 h-6 border border-l-0 border-primary rounded-r-lg flex items-center justify-center text-white font-medium">i</span>
                        </button>
                    <?php endif; ?>
                </div>
            <?php endforeach; ?>
        </div>

        <span class="toggle-option cursor-pointer" data-translated-more="<?= $escaper->escapeHtml(__('Show more')); ?>"
              data-translated-less="<?= $escaper->escapeHtml(__('Show less')); ?>">
            <span class="js-show-more-text flex justify-center mt-2">
                <?= $escaper->escapeHtml(__('Show more')); ?> <?= $escaper->escapeHtml($option->getTitle()) ?> <?= $heroicons->arrowSmDownHtml('', 24, 24, ['aria-hidden="true"']) ?>
            </span>
            <span class="js-show-less-text flex justify-center mt-2" style="display: none;">
                <?= $escaper->escapeHtml(__('Show less')); ?> <?= $escaper->escapeHtml($option->getTitle()) ?> <?= $heroicons->arrowSmUpHtml('', 24, 24, ['aria-hidden="true"']) ?>
            </span>
        </span>

        <template x-if="openModal !== null">
            <div @keydown.escape.window="openModal = null"
                 class="fixed inset-0 z-50 overflow-y-auto"
                 x-cloak>
                <div @click="openModal = null"
                     class="fixed inset-0 bg-black opacity-50 transition-opacity"></div>

                <div class="flex items-center justify-center min-h-screen p-4">
                    <div
                            x-data="{
                        get modalData() {
                            return descriptions[openModal] || { title: '', description: '' };
                        }
                    }"
                            x-transition:enter-start="opacity-0 scale-95"
                            x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave-start="opacity-100 scale-100"
                            x-transition:leave-end="opacity-0 scale-95"
                            @click.stop
                            class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full p-6 relative text-gray-700">
                        <template x-if="modalData.title">
                            <p class="text-lg font-bold text-gray-900 mb-4" x-text="modalData.title"></p>
                        </template>

                        <template x-if="modalData.description">
                            <div class="prose prose-sm max-w-none text-gray-700" x-html="modalData.description"></div>
                        </template>

                        <div class="mt-6 flex justify-end">
                            <button
                                    type="button"
                                    @click="openModal = null"
                                    class="btn btn-primary"
                            >
                                <?= $escaper->escapeHtml(__('Close')) ?>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script>
        function initOptionModal() {
            return {
                openModal: null,
                descriptions: {}
            }
        }
    </script>
<?php endif; ?>
