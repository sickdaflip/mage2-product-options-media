<?php
/*
 * Copyright (C) Philipp Breitsprecher, Inc - All Rights Reserved
 * @project Mage2 GD
 * @file checkable.phtml
 * @author Philipp Breitsprecher
 * @date 18.11.25
 * @email philippbreitsprecher@gmail.com
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\ProductPrice;
use Magento\Catalog\Block\Product\View\Options\Type\Select\Checkable;
use Magento\Catalog\Model\Product\Option;
use Magento\Catalog\Pricing\Price\CustomOptionPrice;
use Magento\Framework\Escaper;
use Magento\Framework\View\Helper\SecureHtmlRenderer;
use Sickdaflip\ProductOptionsMedia\Model\Product\Option\Value\Media;

/**
 * @var Checkable $block
 * @var Escaper $escaper
 * @var ViewModelRegistry $viewModels
 * @var SecureHtmlRenderer $secureRenderer
 */

$product = $block->getProduct();

/** @var ProductPrice $productPriceViewModel */
$productPriceViewModel = $viewModels->require(ProductPrice::class);

/** @var Hyva\Theme\ViewModel\HeroiconsOutline $heroicons */
$heroicons = $viewModels->require(\Hyva\Theme\ViewModel\HeroiconsOutline::class);

// Get Media helper for image URL resolution
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$mediaHelper = $objectManager->get(Media::class);

$option = $block->getOption();

if ($option): ?>
    <?php
    $configValue = $block->getPreconfiguredValue($option);
    $optionType = $option->getType();
    $arraySign = $optionType === Option::OPTION_TYPE_CHECKBOX ? '[]' : '';
    $count = 1;
    ?>

    <div class="options-list nested" x-data="{ openModal: null }"
         id="options-<?= $escaper->escapeHtmlAttr($option->getId()) ?>-list" data-max-items="3">
        <?php if ($optionType === Option::OPTION_TYPE_RADIO && !$option->getIsRequire()): ?>
            <div class="field choice">
                <input type="radio"
                       id="options_<?= $escaper->escapeHtmlAttr($option->getId()) ?>"
                       class="radio product-custom-option"
                       name="options[<?= $escaper->escapeHtmlAttr($option->getId()) ?>]"
                       value=""
                       checked
                       x-on:change="updateCustomOptionValue(
                $dispatch, '<?= $escaper->escapeHtmlAttr($option->getId()) ?>', $event.target
               )"
                />
                <label class="label text-left"
                       for="options_<?= $escaper->escapeHtmlAttr($option->getId()) ?>">
            <span>
                <?= $escaper->escapeHtml(__('None')) ?>
            </span>
                </label>
            </div>
        <?php endif; ?>
        <?php foreach ($option->getValues() as $value): ?>
            <?php
            $checked = '';
            $count++;
            if ($arraySign) {
                $checked = is_array($configValue) && in_array($value->getOptionTypeId(), $configValue) ? 'checked' : '';
            } else {
                $checked = $configValue == $value->getOptionTypeId() ? 'checked' : '';
            }
            $dataSelector = 'options[' . $option->getId() . ']';
            if ($arraySign) {
                $dataSelector .= '[' . $value->getOptionTypeId() . ']';
            }

            $optionId = $option->getId() . '_' . $value->getOptionTypeId();

            $valuePrice = $productPriceViewModel->getCustomOptionPrice($value, CustomOptionPrice::PRICE_CODE, $product);
            if ($productPriceViewModel->displayPriceInclAndExclTax()) {
                $valueBasePrice = $value->getPrice(true);
            }

            // Get image and description
            $hasImage = $value->getData('image');
            $hasDescription = $value->getData('description');
            $imageUrl = $hasImage ? $mediaHelper->getImageUrl($value->getData('image')) : null;
            ?>
            <div class="field choice <?= $hasImage ? 'with-image' : '' ?> <?= $hasDescription ? 'with-description' : '' ?>">
                <input type="<?= $escaper->escapeHtmlAttr($optionType) ?>"
                       class="<?= $optionType === Option::OPTION_TYPE_RADIO
                               ? 'form-radio'
                               : 'form-checkbox' ?>
                       product-custom-option"
                       name="options[<?= $escaper->escapeHtmlAttr($option->getId()) ?>]<?= /* @noEscape */
                       $arraySign ?>"
                       id="options_<?= $escaper->escapeHtmlAttr($optionId) ?>"
                       value="<?= $escaper->escapeHtmlAttr($value->getOptionTypeId()) ?>"
                        <?= $escaper->escapeHtml($checked) ?>
                       x-ref="option-<?= $escaper->escapeHtmlAttr($option->getId() . '-' . $value->getOptionTypeId()) ?>"
                        <?php if ($option->getIsRequire()): ?>
                            required
                            data-required
                            oninvalid="this.setCustomValidity(this.dataset.validationMessage)"
                            oninput="this.setCustomValidity('')"
                            data-validation-message="<?= $escaper
                                    ->escapeHtmlAttr(__("Please select one of the options.")) ?>"
                        <?php endif; ?>
                       data-price-amount="<?= $escaper->escapeHtmlAttr($valuePrice) ?>"
                        <?php if ($productPriceViewModel->displayPriceInclAndExclTax()): ?>
                            data-base-price-amount="<?= $escaper->escapeHtmlAttr($valueBasePrice) ?>"
                        <?php endif; ?>
                       data-price-type="<?= $escaper->escapeHtmlAttr($value->getPriceType()) ?>"
                       data-option-id="<?= $escaper->escapeHtmlAttr($optionId) ?>"
                       x-ref="option-<?= $escaper->escapeHtmlAttr($optionId) ?>"
                       x-on:change="updateCustomOptionValue(
                    $dispatch, '<?= $escaper->escapeHtmlAttr($optionId) ?>', $event.target
                   )"
                />
                <label class="label text-left"
                       for="options_<?= $escaper->escapeHtmlAttr($optionId) ?>"
                >
                    <?php if ($imageUrl): ?>
                        <div class="option-image mb-2">
                            <img
                                src="<?= $escaper->escapeUrl($imageUrl) ?>"
                                alt="<?= $escaper->escapeHtmlAttr($value->getTitle()) ?>"
                                class="w-20 h-20 object-cover rounded border"
                                loading="lazy"
                            >
                        </div>
                    <?php endif; ?>

                    <span x-html="updateOptionPrice('<?= $escaper->escapeJs($optionId) ?>', $el)">
                        <span><?= $escaper->escapeHtml($value->getTitle()) ?></span>
                        <span><?= /* @noEscape */ $block->formatPrice($value) ?></span>
                    </span>

                    <?php if ($hasDescription): ?>
                        <button
                            type="button"
                            @click.prevent="openModal = '<?= $escaper->escapeHtmlAttr($optionId) ?>'"
                            class="text-primary hover:text-primary-darker text-sm mt-1 flex items-center gap-1"
                        >
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            <?= $escaper->escapeHtml(__('More Info')) ?>
                        </button>
                    <?php endif; ?>
                </label>
            </div>

            <?php if ($hasDescription): ?>
                <!-- Description Modal -->
                <template x-teleport="body">
                    <div
                        x-show="openModal === '<?= $escaper->escapeHtmlAttr($optionId) ?>'"
                        x-cloak
                        @keydown.escape.window="openModal = null"
                        class="fixed inset-0 z-50 overflow-y-auto"
                        style="display: none;"
                    >
                        <div
                            @click="openModal = null"
                            class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"
                        ></div>

                        <div class="flex items-center justify-center min-h-screen p-4">
                            <div
                                x-show="openModal === '<?= $escaper->escapeHtmlAttr($optionId) ?>'"
                                x-transition:enter="transition ease-out duration-300"
                                x-transition:enter-start="opacity-0 scale-95"
                                x-transition:enter-end="opacity-100 scale-100"
                                x-transition:leave="transition ease-in duration-200"
                                x-transition:leave-start="opacity-100 scale-100"
                                x-transition:leave-end="opacity-0 scale-95"
                                class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full p-6 relative"
                                @click.stop
                            >
                                <h3 class="text-lg font-bold text-gray-900 mb-4">
                                    <?= $escaper->escapeHtml($value->getTitle()) ?>
                                </h3>

                                <div class="prose prose-sm max-w-none text-gray-700">
                                    <?= /* @noEscape */ $value->getData('description') ?>
                                </div>

                                <div class="mt-6 flex justify-end">
                                    <button
                                        type="button"
                                        @click="openModal = null"
                                        class="btn btn-primary"
                                    >
                                        <?= $escaper->escapeHtml(__('Close')) ?>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            <?php endif; ?>
        <?php endforeach; ?>
    </div>
    <span class="toggle-option cursor-pointer" data-translated-more="<?= $block->escapeHtml(__('Show more')); ?>"
          data-translated-less="<?= $block->escapeHtml(__('Show less')); ?>">
        <span class="js-show-more-text flex items-center mt-2">
            <?= $block->escapeHtml(__('Show more')); ?> <?= $escaper->escapeHtml($option->getTitle()) ?> <?= $heroicons->arrowSmDownHtml('', 24, 24, ['aria-hidden="true"']) ?>
        </span>
        <span class="js-show-less-text flex items-center mt-2" style="display: none;">
            <?= $block->escapeHtml(__('Show less')); ?> <?= $escaper->escapeHtml($option->getTitle()) ?> <?= $heroicons->arrowSmUpHtml('', 24, 24, ['aria-hidden="true"']) ?>
        </span>
    </span>
<?php endif; ?>
