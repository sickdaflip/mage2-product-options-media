<?php
/*
 * Copyright (C) Philipp Breitsprecher, Inc - All Rights Reserved
 * @project Mage2 GD
 * @file options-media.phtml
 * @author Philipp Breitsprecher
 * @date 18.11.25, 20:30
 * @email philippbreitsprecher@gmail.com
 */

declare(strict_types=1);

/** @var \Magento\Framework\View\Element\Template $block */
/** @var \Magento\Framework\Escaper $escaper */

$uploadUrl = $block->getUrl('productoptions/product_option/uploadImage');
$mediaGalleryUrl = $block->getUrl('cms/wysiwyg_images/index', [
    'target_element_id' => 'TARGET_ELEMENT_ID'
]);
?>

<script>
require([
    'jquery',
    'mage/translate',
    'mage/adminhtml/browser'
], function($, $t) {
    'use strict';

    var uploadUrl = '<?= $escaper->escapeJs($uploadUrl) ?>';
    var mediaGalleryUrl = '<?= $escaper->escapeJs($mediaGalleryUrl) ?>';

    /**
     * Convert absolute path to relative path
     * e.g. /media/wysiwyg/image.jpg -> wysiwyg/image.jpg
     * e.g. {{media url="wysiwyg/image.jpg"}} -> wysiwyg/image.jpg
     */
    function toRelativePath(path) {
        if (!path) return path;

        // Handle Magento directive format
        var directiveMatch = path.match(/\{\{media url="([^"]+)"\}\}/);
        if (directiveMatch) {
            return directiveMatch[1];
        }

        // Remove leading /media/ or media/
        path = path.replace(/^\/media\//, '').replace(/^media\//, '');

        // Remove any URL parts (http://..../media/)
        path = path.replace(/^https?:\/\/[^\/]+\/media\//, '');

        return path;
    }

    function addImageButtons() {
        // Find all image input fields in the custom options values
        $('input[name*="[values]"][name*="[image]"]').each(function() {
            var $input = $(this);

            // Skip if buttons already added
            if ($input.data('buttons-added')) {
                return;
            }

            // Ensure input has unique ID
            if (!$input.attr('id')) {
                $input.attr('id', 'option_image_' + Math.random().toString(36).substr(2, 9));
            }

            var inputId = $input.attr('id');
            var $wrapper = $input.parent();

            // Create button container
            var $buttonContainer = $('<div class="admin__field-control-buttons" style="margin-top: 5px;"></div>');

            // Upload button
            var $uploadBtn = $('<button type="button" class="action-default scalable" title="' + $t('Upload') + '">' +
                '<span>' + $t('Upload') + '</span></button>');

            // Gallery button
            var $galleryBtn = $('<button type="button" class="action-default scalable" title="' + $t('Gallery') + '" style="margin-left: 5px;">' +
                '<span>' + $t('Gallery') + '</span></button>');

            $buttonContainer.append($uploadBtn).append($galleryBtn);
            $wrapper.append($buttonContainer);

            // Upload functionality
            var $fileInput = $('<input type="file" accept="image/*" style="display: none;">');
            $wrapper.append($fileInput);

            $uploadBtn.on('click', function(e) {
                e.preventDefault();
                $fileInput.trigger('click');
            });

            $fileInput.on('change', function() {
                var file = this.files[0];
                if (!file) return;

                var formData = new FormData();
                formData.append('image', file);
                formData.append('form_key', window.FORM_KEY);

                $uploadBtn.prop('disabled', true).text($t('Uploading...'));

                $.ajax({
                    url: uploadUrl,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.error) {
                            alert(response.error);
                        } else if (response.file) {
                            $input.val(response.file).trigger('change');
                        }
                    },
                    error: function() {
                        alert($t('Upload failed. Please try again.'));
                    },
                    complete: function() {
                        $uploadBtn.prop('disabled', false).html('<span>' + $t('Upload') + '</span>');
                        $fileInput.val('');
                    }
                });
            });

            // Gallery functionality
            $galleryBtn.on('click', function(e) {
                e.preventDefault();

                var url = mediaGalleryUrl.replace('TARGET_ELEMENT_ID', inputId);

                MediabrowserUtility.openDialog(url, false, false, $t('Insert Image'), {
                    closed: function() {
                        // Convert to relative path after closing
                        var currentVal = $input.val();
                        var relativePath = toRelativePath(currentVal);
                        if (relativePath !== currentVal) {
                            $input.val(relativePath);
                        }
                    }
                });
            });

            // Watch for changes and convert to relative path
            $input.on('change', function() {
                var currentVal = $input.val();
                var relativePath = toRelativePath(currentVal);
                if (relativePath !== currentVal) {
                    $input.val(relativePath);
                }
            });

            $input.data('buttons-added', true);
        });
    }

    // Initial run
    $(document).ready(function() {
        setTimeout(addImageButtons, 1000);
    });

    // Watch for dynamic content
    var observer = new MutationObserver(function(mutations) {
        setTimeout(addImageButtons, 100);
    });

    // Observe the product form
    var targetNode = document.querySelector('#product_form') || document.querySelector('[data-form="edit-product"]') || document.body;
    observer.observe(targetNode, {
        childList: true,
        subtree: true
    });
});
</script>
